#!/usr/bin/env ruby

require 'net/http'
require 'rss_to_turtle'

def log(type, message)
  output = type == :error ? $stderr : $stdout
  output.puts "#{Time.now.utc.iso8601} - #{type.upcase}: #{message}"
end

feed_url = URI('http://webfoundation.org/feed/')

log(:info, "Converting rss to turtle")
turtle = RSSToTurtle.convert_from_url(feed_url)

log(:info, "Loading data in to semantic repository")

host = 'localhost'
port = '3030'
path = '/articles/data?default'

headers = {}
headers["Content-Type"] = "text/turtle;charset=utf-8;charset=utf-8"

request = Net::HTTP::Put.new(path)
request.initialize_http_header(headers)
request.body = turtle

response = Net::HTTP.new(host, port).start {|http| http.request(request) }

if response.kind_of? Net::HTTPSuccess
  log(:info, "Data loaded successfully.")
else
  log(:error, "Failed to load data: #{response.code}")
  exit 1
end
